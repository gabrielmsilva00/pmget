#!/usr/bin/env bash
# pget - Package Getter (https://github.com/gabrielmsilva00/pget)
set -euo pipefail

VERSION="1.0.0"

BOLD=$(tput bold 2>/dev/null) || BOLD=""
RESET=$(tput sgr0 2>/dev/null) || RESET=""
RED=$(tput setaf 1 2>/dev/null) || RED=""
GREEN=$(tput setaf 2 2>/dev/null) || GREEN=""
YELLOW=$(tput setaf 3 2>/dev/null) || YELLOW=""
CYAN=$(tput setaf 6 2>/dev/null) || CYAN=""

CLI_MODE=false
USE_SUDO=false
declare -a INSTALL_PKGS=()
declare -a REMOVE_PKGS=()
DETECTED_PM=""

cleanup() { tput cnorm 2>/dev/null || true; }
trap cleanup EXIT INT

detect_pm() {
    for pm in pkg nala apt dnf yum pacman zypper apk; do
        command -v "$pm" &>/dev/null && { DETECTED_PM="$pm"; return 0; }
    done
    echo "${RED}No package manager found${RESET}" >&2; exit 1
}

run_pm() {
    local action="$1"; shift; local cmd=()
    [[ "$USE_SUDO" == true ]] && cmd+=(sudo)
    case "$DETECTED_PM:$action" in
        pkg:install)    cmd+=(pkg install -y "$@") ;;
        pkg:remove)     cmd+=(pkg uninstall -y "$@") ;;
        nala:install)   cmd+=(nala install -y "$@") ;;
        nala:remove)    cmd+=(nala remove -y "$@") ;;
        apt:install)    cmd+=(apt install -y "$@") ;;
        apt:remove)     cmd+=(apt remove -y "$@") ;;
        dnf:install)    cmd+=(dnf install -y "$@") ;;
        dnf:remove)     cmd+=(dnf remove -y "$@") ;;
        yum:install)    cmd+=(yum install -y "$@") ;;
        yum:remove)     cmd+=(yum remove -y "$@") ;;
        pacman:install) cmd+=(pacman -S --noconfirm "$@") ;;
        pacman:remove)  cmd+=(pacman -R --noconfirm "$@") ;;
        zypper:install) cmd+=(zypper install -y "$@") ;;
        zypper:remove)  cmd+=(zypper remove -y "$@") ;;
        apk:install)    cmd+=(apk add "$@") ;;
        apk:remove)     cmd+=(apk del "$@") ;;
    esac
    "${cmd[@]}"
}

get_packages() {
    case "$DETECTED_PM" in
        pkg)      pkg list-all 2>/dev/null | cut -d/ -f1 ;;
        nala|apt) apt-cache pkgnames 2>/dev/null ;;
        dnf)      dnf repoquery --qf '%{name}' 2>/dev/null ;;
        yum)      yum list available 2>/dev/null | awk 'NR>1{print $1}' | cut -d. -f1 ;;
        pacman)   pacman -Slq 2>/dev/null ;;
        zypper)   zypper packages 2>/dev/null | awk -F'|' 'NR>4{gsub(/ /,"",$3);print $3}' ;;
        apk)      apk search -q 2>/dev/null ;;
    esac
}

get_installed() {
    case "$DETECTED_PM" in
        pkg|nala|apt) dpkg-query -W -f='${Package}\n' 2>/dev/null ;;
        dnf|yum)      rpm -qa --qf '%{NAME}\n' 2>/dev/null ;;
        pacman)       pacman -Qq 2>/dev/null ;;
        zypper)       rpm -qa --qf '%{NAME}\n' 2>/dev/null ;;
        apk)          apk list -I 2>/dev/null | cut -d' ' -f1 | sed 's/-[0-9].*//' ;;
    esac
}

show_info() {
    echo -e "${BOLD}${CYAN}Package Info:${RESET}\n"
    case "$DETECTED_PM" in
        pkg)      pkg show "$1" 2>/dev/null ;;
        nala)     nala show "$1" 2>/dev/null ;;
        apt)      apt show "$1" 2>/dev/null ;;
        dnf)      dnf info "$1" 2>/dev/null ;;
        yum)      yum info "$1" 2>/dev/null ;;
        pacman)   pacman -Si "$1" 2>/dev/null || pacman -Qi "$1" 2>/dev/null ;;
        zypper)   zypper info "$1" 2>/dev/null ;;
        apk)      apk info -a "$1" 2>/dev/null ;;
    esac
}

parse_args() {
    local mode=""
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -c) CLI_MODE=true ;;
            -s) USE_SUDO=true ;;
            -i) mode="i" ;;
            -r) mode="r" ;;
            -v) echo "pget v${VERSION}"; exit 0 ;;
            -h) echo "pget v${VERSION} | -c cli -s sudo -i install -r remove"; exit 0 ;;
            --info) detect_pm; show_info "$2"; exit 0 ;;
            *) [[ "$mode" == "i" ]] && INSTALL_PKGS+=("$1"); [[ "$mode" == "r" ]] && REMOVE_PKGS+=("$1") ;;
        esac
        shift
    done
}

run_cli() {
    echo "${BOLD}${CYAN}pget${RESET} ($DETECTED_PM)$([[ "$USE_SUDO" == true ]] && echo " [sudo]")"
    [[ ${#REMOVE_PKGS[@]} -gt 0 ]] && { echo "${RED}Remove:${RESET} ${REMOVE_PKGS[*]}"; run_pm remove "${REMOVE_PKGS[@]}"; echo; }
    [[ ${#INSTALL_PKGS[@]} -gt 0 ]] && { echo "${GREEN}Install:${RESET} ${INSTALL_PKGS[*]}"; run_pm install "${INSTALL_PKGS[@]}"; }
    [[ ${#INSTALL_PKGS[@]} -eq 0 && ${#REMOVE_PKGS[@]} -eq 0 ]] && echo "${YELLOW}No packages${RESET}"
}

# Simple TUI: select packages then choose action
run_tui() {
    tput civis 2>/dev/null || true
    
    # Get packages and pipe to fzf
    local selected
    selected=$(get_packages | fzf -m \
        --prompt="${BOLD}${GREEN}Select packages: ${RESET}" \
        --header="Tab=multi-select  Enter=confirm  ?=info  Esc=quit" \
        --preview="$0 --info {}" \
        --preview-window="top:40%" \
        --bind="?:toggle-preview" \
        --info=inline \
        --ansi 2>/dev/tty) || true
    
    tput cnorm 2>/dev/null || true
    
    # No selection
    [[ -z "$selected" ]] && { echo "${CYAN}Exit${RESET}"; exit 0; }
    
    # Convert to space-separated
    local packages=$(echo "$selected" | tr '\n' ' ')
    echo "Selected: $packages"
    
    # Ask what to do
    while true; do
        local stxt=""; [[ "$USE_SUDO" == true ]] && stxt=" ${CYAN}[sudo]${RESET}"
        read -n1 -rp "[i]nstall [r]emove [s]udo($USE_SUDO) [m]ore [q]uit:$stxt " action </dev/tty
        echo
        
        case "$action" in
            i|I)
                local cmd="pget -c"
                [[ "$USE_SUDO" == true ]] && cmd+=" -s"
                cmd+=" -i $packages"
                echo "${CYAN}> $cmd${RESET}"
                eval "$cmd"
                break
                ;;
            r|R)
                local cmd="pget -c"
                [[ "$USE_SUDO" == true ]] && cmd+=" -s"
                cmd+=" -r $packages"
                echo "${CYAN}> $cmd${RESET}"
                eval "$cmd"
                break
                ;;
            s|S)
                USE_SUDO=$([[ "$USE_SUDO" == true ]] && echo false || echo true)
                ;;
            m|M)
                # Select more packages
                run_tui
                break
                ;;
            q|Q|"")
                echo "${CYAN}Exit${RESET}"
                break
                ;;
            *)
                echo "${RED}i/r/s/m/q${RESET}"
                ;;
        esac
    done
}

main() {
    parse_args "$@"
    detect_pm
    [[ "$CLI_MODE" == true ]] && run_cli || run_tui
}

main "$@"
