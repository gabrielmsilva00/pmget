#!/usr/bin/env bash
set -euo pipefail

VERSION="1.0.0"

BOLD=$(tput bold 2>/dev/null) || BOLD=""
RESET=$(tput sgr0 2>/dev/null) || RESET=""
RED=$(tput setaf 1 2>/dev/null) || RED=""
GREEN=$(tput setaf 2 2>/dev/null) || GREEN=""
YELLOW=$(tput setaf 3 2>/dev/null) || YELLOW=""
CYAN=$(tput setaf 6 2>/dev/null) || CYAN=""

CLI_MODE=false
USE_SUDO=false
declare -a INSTALL_PKGS=()
declare -a REMOVE_PKGS=()
DETECTED_PM=""

cleanup() { tput cnorm 2>/dev/null || true; }
trap cleanup EXIT INT

detect_pm() {
    for pm in pkg nala apt dpkg dnf yum pacman zypper apk; do
        command -v "$pm" &>/dev/null && { DETECTED_PM="$pm"; return 0; }
    done
    echo "${RED}No supported package manager${RESET}" >&2; exit 1
}

run_pm() {
    local action="$1"; shift
    local cmd=(); [[ "$USE_SUDO" == true ]] && cmd+=(sudo)
    case "$DETECTED_PM:$action" in
        pkg:install)    cmd+=(pkg install -y "$@") ;;
        pkg:remove)     cmd+=(pkg uninstall -y "$@") ;;
        nala:install)   cmd+=(nala install -y "$@") ;;
        nala:remove)    cmd+=(nala remove -y "$@") ;;
        apt:install)    cmd+=(apt install -y "$@") ;;
        apt:remove)     cmd+=(apt remove -y "$@") ;;
        dpkg:install)   cmd+=(dpkg -i "$@") ;;
        dpkg:remove)    cmd+=(dpkg -r "$@") ;;
        dnf:install)    cmd+=(dnf install -y "$@") ;;
        dnf:remove)     cmd+=(dnf remove -y "$@") ;;
        yum:install)    cmd+=(yum install -y "$@") ;;
        yum:remove)     cmd+=(yum remove -y "$@") ;;
        pacman:install) cmd+=(pacman -S --noconfirm "$@") ;;
        pacman:remove)  cmd+=(pacman -R --noconfirm "$@") ;;
        zypper:install) cmd+=(zypper install -y "$@") ;;
        zypper:remove)  cmd+=(zypper remove -y "$@") ;;
        apk:install)    cmd+=(apk add "$@") ;;
        apk:remove)     cmd+=(apk del "$@") ;;
    esac
    "${cmd[@]}"
}

list_packages() {
    case "$DETECTED_PM" in
        pkg)      pkg list-all 2>/dev/null | cut -d/ -f1 ;;
        nala|apt) apt-cache pkgnames 2>/dev/null ;;
        dpkg)     dpkg-query -W -f='${Package}\n' 2>/dev/null ;;
        dnf)      dnf repoquery --qf '%{name}' 2>/dev/null ;;
        yum)      yum list available 2>/dev/null | awk 'NR>1{print $1}' | cut -d. -f1 ;;
        pacman)   pacman -Slq 2>/dev/null ;;
        zypper)   zypper packages 2>/dev/null | awk -F'|' 'NR>4{gsub(/ /,"",$3);print $3}' ;;
        apk)      apk search -q 2>/dev/null ;;
    esac
}

list_installed() {
    case "$DETECTED_PM" in
        pkg|nala|apt|dpkg) dpkg-query -W -f='${Package}\n' 2>/dev/null ;;
        dnf|yum)  rpm -qa --qf '%{NAME}\n' 2>/dev/null ;;
        pacman)   pacman -Qq 2>/dev/null ;;
        zypper)   rpm -qa --qf '%{NAME}\n' 2>/dev/null ;;
        apk)      apk list -I 2>/dev/null | cut -d' ' -f1 | sed 's/-[0-9].*//' ;;
    esac
}

show_info() {
    echo -e "${BOLD}${CYAN}Package Info:${RESET}\n"
    case "$DETECTED_PM" in
        pkg)      pkg show "$1" 2>/dev/null ;;
        nala)     nala show "$1" 2>/dev/null ;;
        apt|dpkg) apt show "$1" 2>/dev/null ;;
        dnf)      dnf info "$1" 2>/dev/null ;;
        yum)      yum info "$1" 2>/dev/null ;;
        pacman)   pacman -Si "$1" 2>/dev/null || pacman -Qi "$1" 2>/dev/null ;;
        zypper)   zypper info "$1" 2>/dev/null ;;
        apk)      apk info -a "$1" 2>/dev/null ;;
    esac
}

show_help() { echo "pget v${VERSION} | -c=cli -s=sudo -i=install -r=remove -v=version -h=help"; exit 0; }

parse_args() {
    local mode=""
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -c) CLI_MODE=true ;;
            -s) USE_SUDO=true ;;
            -i) mode="i" ;;
            -r) mode="r" ;;
            -v) echo "pget v${VERSION}"; exit 0 ;;
            -h) show_help ;;
            --info) detect_pm; show_info "$2"; exit 0 ;;
            -*) echo "${RED}Unknown: $1${RESET}" >&2; exit 1 ;;
            *) [[ "$mode" == "i" ]] && INSTALL_PKGS+=("$1"); [[ "$mode" == "r" ]] && REMOVE_PKGS+=("$1") ;;
        esac
        shift
    done
}

run_cli() {
    echo "${BOLD}${CYAN}pget${RESET} (${DETECTED_PM})$([[ "$USE_SUDO" == true ]] && echo " [sudo]")"
    [[ ${#REMOVE_PKGS[@]} -gt 0 ]] && { echo "${RED}Removing:${RESET} ${REMOVE_PKGS[*]}"; run_pm remove "${REMOVE_PKGS[@]}"; echo; }
    [[ ${#INSTALL_PKGS[@]} -gt 0 ]] && { echo "${GREEN}Installing:${RESET} ${INSTALL_PKGS[*]}"; run_pm install "${INSTALL_PKGS[@]}"; }
    [[ ${#INSTALL_PKGS[@]} -eq 0 && ${#REMOVE_PKGS[@]} -eq 0 ]] && echo "${YELLOW}No packages${RESET}"
}

# TUI - goes directly to fzf
run_tui() {
    tput civis 2>/dev/null || true
    
    # Direct to fzf with all packages
    local packages=$(list_packages | fzf -m \
        --prompt="${BOLD}${GREEN}Package: ${RESET}" \
        --header="Tab=select Enter=confirm ?=info" \
        --preview="$0 --info {}" \
        --preview-window="top:40%" \
        --bind="?:toggle-preview" \
        --info=inline \
        --ansi | tr "\n" " ")
    
    tput cnorm 2>/dev/null || true
    
    [[ -z "$packages" ]] && { echo "${CYAN}No selection${RESET}"; exit 0; }
    
    echo "Selected: $packages"
    
    # Ask action
    while true; do
        read -n1 -rp "[i]nstall/[r]emove/[s]udo($USE_SUDO)/[q]uit: " act
        echo
        case "$act" in
            i|I)
                local cmd="pget -c"; [[ "$USE_SUDO" == true ]] && cmd+=" -s"
                cmd+=" -i $packages"
                echo "${CYAN}> $cmd${RESET}"; eval "$cmd"; break ;;
            r|R)
                local cmd="pget -c"; [[ "$USE_SUDO" == true ]] && cmd+=" -s"
                cmd+=" -r $packages"
                echo "${CYAN}> $cmd${RESET}"; eval "$cmd"; break ;;
            s|S) USE_SUDO=$([[ "$USE_SUDO" == true ]] && echo false || echo true); echo "sudo=$USE_SUDO" ;;
            q|Q|"") echo "${CYAN}Exit${RESET}"; break ;;
            *) echo "${RED}i/r/s/q${RESET}" ;;
        esac
    done
}

main() {
    parse_args "$@"
    detect_pm
    [[ "$CLI_MODE" == true ]] && run_cli || run_tui
}

main "$@"
