#!/usr/bin/env bash
set -euo pipefail

VERSION="1.0.0"

BOLD=$(tput bold 2>/dev/null) || BOLD=""
RESET=$(tput sgr0 2>/dev/null) || RESET=""
RED=$(tput setaf 1 2>/dev/null) || RED=""
GREEN=$(tput setaf 2 2>/dev/null) || GREEN=""
YELLOW=$(tput setaf 3 2>/dev/null) || YELLOW=""
CYAN=$(tput setaf 6 2>/dev/null) || CYAN=""

CLI_MODE=false
USE_SUDO=false
declare -a INSTALL_PKGS=()
declare -a REMOVE_PKGS=()
DETECTED_PM=""

readonly PKG_REGEX='^[a-zA-Z0-9][a-zA-Z0-9.+_-]*$'

cleanup() {
    tput cnorm 2>/dev/null || true
}
trap cleanup EXIT INT

detect_pm() {
    local -a pms=(pkg nala apt dpkg dnf yum pacman zypper apk)
    for pm in "${pms[@]}"; do
        command -v "$pm" &>/dev/null && { DETECTED_PM="$pm"; return 0; }
    done
    echo "${RED}No supported package manager found${RESET}" >&2
    exit 1
}

run_pm() {
    local action="$1"; shift
    local cmd=()
    [[ "$USE_SUDO" == true ]] && cmd+=(sudo)
    
    case "$DETECTED_PM:$action" in
        pkg:install)     cmd+=(pkg install -y "$@") ;;
        pkg:remove)      cmd+=(pkg uninstall -y "$@") ;;
        nala:install)    cmd+=(nala install -y "$@") ;;
        nala:remove)     cmd+=(nala remove -y "$@") ;;
        apt:install)     cmd+=(apt install -y "$@") ;;
        apt:remove)      cmd+=(apt remove -y "$@") ;;
        dpkg:install)    cmd+=(dpkg -i "$@") ;;
        dpkg:remove)     cmd+=(dpkg -r "$@") ;;
        dnf:install)     cmd+=(dnf install -y "$@") ;;
        dnf:remove)      cmd+=(dnf remove -y "$@") ;;
        yum:install)     cmd+=(yum install -y "$@") ;;
        yum:remove)      cmd+=(yum remove -y "$@") ;;
        pacman:install)  cmd+=(pacman -S --noconfirm "$@") ;;
        pacman:remove)   cmd+=(pacman -R --noconfirm "$@") ;;
        zypper:install)  cmd+=(zypper install -y "$@") ;;
        zypper:remove)   cmd+=(zypper remove -y "$@") ;;
        apk:install)     cmd+=(apk add "$@") ;;
        apk:remove)      cmd+=(apk del "$@") ;;
    esac
    "${cmd[@]}"
}

list_packages() {
    case "$DETECTED_PM" in
        pkg)      pkg list-all 2>/dev/null | cut -d/ -f1 ;;
        nala|apt) apt-cache pkgnames 2>/dev/null ;;
        dpkg)     dpkg-query -W -f='${Package}\n' 2>/dev/null ;;
        dnf)      dnf repoquery --qf '%{name}' 2>/dev/null ;;
        yum)      yum list available 2>/dev/null | awk 'NR>1{print $1}' | cut -d. -f1 ;;
        pacman)   pacman -Slq 2>/dev/null ;;
        zypper)   zypper packages 2>/dev/null | awk -F'|' 'NR>4{gsub(/ /,"",$3);print $3}' ;;
        apk)      apk search -q 2>/dev/null ;;
    esac
}

list_installed() {
    case "$DETECTED_PM" in
        pkg|nala|apt|dpkg) dpkg-query -W -f='${Package}\n' 2>/dev/null ;;
        dnf|yum)  rpm -qa --qf '%{NAME}\n' 2>/dev/null ;;
        pacman)   pacman -Qq 2>/dev/null ;;
        zypper)   rpm -qa --qf '%{NAME}\n' 2>/dev/null ;;
        apk)      apk list -I 2>/dev/null | cut -d' ' -f1 | sed 's/-[0-9].*//' ;;
    esac
}

show_pkg_info() {
    local pkg="$1"
    echo -e "${BOLD}${CYAN}Package Information:${RESET}\n"
    case "$DETECTED_PM" in
        pkg)      pkg show "$pkg" 2>/dev/null ;;
        nala)     nala show "$pkg" 2>/dev/null ;;
        apt|dpkg) apt show "$pkg" 2>/dev/null ;;
        dnf)      dnf info "$pkg" 2>/dev/null ;;
        yum)      yum info "$pkg" 2>/dev/null ;;
        pacman)   pacman -Si "$pkg" 2>/dev/null || pacman -Qi "$pkg" 2>/dev/null ;;
        zypper)   zypper info "$pkg" 2>/dev/null ;;
        apk)      apk info -a "$pkg" 2>/dev/null ;;
    esac
}

show_help() {
    cat <<EOF
${BOLD}pget${RESET} v${VERSION} - Package Getter

${BOLD}Usage:${RESET}
  pget              TUI mode (install)
  pget -r           TUI mode (remove)
  pget -c -i <pkgs> CLI install
  pget -c -r <pkgs> CLI remove

${BOLD}Options:${RESET}
  -c    CLI mode
  -s    Use sudo
  -i    Install packages
  -r    Remove packages (TUI: remove mode)
  -v    Show version
  -h    Help

${BOLD}TUI:${RESET} Tab=multi-select, Enter=confirm, ?=info
EOF
    exit 0
}

parse_args() {
    local mode=""
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -c|--cli)     CLI_MODE=true ;;
            -s|--sudo)    USE_SUDO=true ;;
            -i|--install) mode="i" ;;
            -r|--remove)  mode="r" ;;
            -v|--version) echo "pget v${VERSION}"; exit 0 ;;
            -h|--help)    show_help ;;
            --info)       detect_pm; show_pkg_info "$2"; exit 0 ;;
            -*)           echo "${RED}Unknown: $1${RESET}" >&2; exit 1 ;;
            *)
                [[ "$1" =~ $PKG_REGEX ]] || { echo "${RED}Invalid: $1${RESET}" >&2; exit 1; }
                [[ "$mode" == "i" ]] && INSTALL_PKGS+=("$1")
                [[ "$mode" == "r" ]] && REMOVE_PKGS+=("$1")
                ;;
        esac
        shift
    done
    
    # -r without -c means TUI remove mode
    [[ "$CLI_MODE" == false && "$mode" == "r" ]] && TUI_MODE="remove" || TUI_MODE="install"
}

run_cli() {
    local rc=0
    echo "${BOLD}${CYAN}pget${RESET} (${DETECTED_PM})$([[ "$USE_SUDO" == true ]] && echo " ${CYAN}[sudo]${RESET}")"
    echo
    
    if [[ ${#REMOVE_PKGS[@]} -gt 0 ]]; then
        echo "${RED}Removing:${RESET} ${REMOVE_PKGS[*]}"
        run_pm remove "${REMOVE_PKGS[@]}" && echo "${GREEN}✓ Done${RESET}" || { echo "${RED}✗ Failed${RESET}"; rc=1; }
        echo
    fi
    
    if [[ ${#INSTALL_PKGS[@]} -gt 0 ]]; then
        echo "${GREEN}Installing:${RESET} ${INSTALL_PKGS[*]}"
        run_pm install "${INSTALL_PKGS[@]}" && echo "${GREEN}✓ Done${RESET}" || { echo "${RED}✗ Failed${RESET}"; rc=1; }
    fi
    
    [[ ${#INSTALL_PKGS[@]} -eq 0 && ${#REMOVE_PKGS[@]} -eq 0 ]] && {
        echo "${YELLOW}No packages specified${RESET}"
        rc=1
    }
    exit $rc
}

run_tui() {
    local mode="${TUI_MODE:-install}"
    
    tput civis 2>/dev/null || true
    
    local packages
    if [[ "$mode" == "install" ]]; then
        packages=$(list_packages | fzf -m \
            --prompt="${BOLD}${GREEN}Install: ${RESET}" \
            --header="Tab: multi-select | Enter: confirm | ?: info" \
            --preview="$0 --info {}" \
            --preview-window="top:40%" \
            --bind="?:toggle-preview" \
            --info=inline \
            --ansi | tr "\n" " ")
    else
        packages=$(list_installed | fzf -m \
            --prompt="${BOLD}${RED}Remove: ${RESET}" \
            --header="Tab: multi-select | Enter: confirm | ?: info" \
            --preview="$0 --info {}" \
            --preview-window="top:40%" \
            --bind="?:toggle-preview" \
            --info=inline \
            --ansi | tr "\n" " ")
    fi
    
    tput cnorm 2>/dev/null || true
    
    if [[ -z "$packages" ]]; then
        echo "${CYAN}No package selected${RESET}"
        exit 0
    fi
    
    echo "Selected: $packages"
    echo
    
    while true; do
        local sudo_txt=""
        [[ "$USE_SUDO" == true ]] && sudo_txt=" ${CYAN}[sudo]${RESET}"
        
        if [[ "$mode" == "install" ]]; then
            read -n1 -rp "Install?${sudo_txt} [Y/n/s/q]: " choice
        else
            read -n1 -rp "Remove?${sudo_txt} [Y/n/s/q]: " choice
        fi
        echo
        
        case "$choice" in
            ""|y|Y)
                echo
                local cmd="pget -c"
                [[ "$USE_SUDO" == true ]] && cmd+=" -s"
                [[ "$mode" == "install" ]] && cmd+=" -i $packages" || cmd+=" -r $packages"
                echo "${CYAN}> ${cmd}${RESET}"
                echo
                eval "$cmd"
                break
                ;;
            n|N) run_tui; break ;;
            s|S)
                USE_SUDO=$([[ "$USE_SUDO" == true ]] && echo false || echo true)
                echo "sudo: $USE_SUDO"
                ;;
            q|Q) echo "${CYAN}Exit${RESET}"; break ;;
            *) echo "${RED}Y/n/s/q${RESET}" ;;
        esac
    done
}

main() {
    TUI_MODE="install"
    parse_args "$@"
    detect_pm
    
    if [[ "$CLI_MODE" == true ]]; then
        run_cli
    else
        run_tui
    fi
}

main "$@"
