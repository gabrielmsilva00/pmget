#!/usr/bin/env bash
set -euo pipefail

VERSION="1.0.0"

BOLD=$(tput bold 2>/dev/null) || BOLD=""
RESET=$(tput sgr0 2>/dev/null) || RESET=""
RED=$(tput setaf 1 2>/dev/null) || RED=""
GREEN=$(tput setaf 2 2>/dev/null) || GREEN=""
YELLOW=$(tput setaf 3 2>/dev/null) || YELLOW=""
CYAN=$(tput setaf 6 2>/dev/null) || CYAN=""

CLI_MODE=false
USE_SUDO=false
MODE="install"  # install or remove
declare -a PACKAGES=()
DETECTED_PM=""

readonly PKG_REGEX='^[a-zA-Z0-9][a-zA-Z0-9.+_-]*$'

cleanup() {
    tput cnorm 2>/dev/null || true
}
trap cleanup EXIT INT

detect_pm() {
    local -a pms=(pkg nala apt dpkg dnf yum pacman zypper apk)
    for pm in "${pms[@]}"; do
        command -v "$pm" &>/dev/null && { DETECTED_PM="$pm"; return 0; }
    done
    echo "${RED}No supported package manager found${RESET}" >&2
    exit 1
}

run_pm() {
    local action="$1"; shift
    local cmd=()
    [[ "$USE_SUDO" == true ]] && cmd+=(sudo)
    
    case "$DETECTED_PM:$action" in
        pkg:install)     cmd+=(pkg install -y "$@") ;;
        pkg:remove)      cmd+=(pkg uninstall -y "$@") ;;
        nala:install)    cmd+=(nala install -y "$@") ;;
        nala:remove)     cmd+=(nala remove -y "$@") ;;
        apt:install)     cmd+=(apt install -y "$@") ;;
        apt:remove)      cmd+=(apt remove -y "$@") ;;
        dpkg:install)    cmd+=(dpkg -i "$@") ;;
        dpkg:remove)     cmd+=(dpkg -r "$@") ;;
        dnf:install)     cmd+=(dnf install -y "$@") ;;
        dnf:remove)      cmd+=(dnf remove -y "$@") ;;
        yum:install)     cmd+=(yum install -y "$@") ;;
        yum:remove)      cmd+=(yum remove -y "$@") ;;
        pacman:install)  cmd+=(pacman -S --noconfirm "$@") ;;
        pacman:remove)   cmd+=(pacman -R --noconfirm "$@") ;;
        zypper:install)  cmd+=(zypper install -y "$@") ;;
        zypper:remove)   cmd+=(zypper remove -y "$@") ;;
        apk:install)     cmd+=(apk add "$@") ;;
        apk:remove)      cmd+=(apk del "$@") ;;
    esac
    "${cmd[@]}"
}

list_available() {
    case "$DETECTED_PM" in
        pkg)      pkg list-all 2>/dev/null | cut -d/ -f1 ;;
        nala|apt) apt-cache pkgnames 2>/dev/null ;;
        dpkg)     dpkg-query -W -f='${Package}\n' 2>/dev/null ;;
        dnf)      dnf repoquery --qf '%{name}' 2>/dev/null ;;
        yum)      yum list available 2>/dev/null | awk 'NR>1{print $1}' | cut -d. -f1 ;;
        pacman)   pacman -Slq 2>/dev/null ;;
        zypper)   zypper packages 2>/dev/null | awk -F'|' 'NR>4{gsub(/ /,"",$3);print $3}' ;;
        apk)      apk search -q 2>/dev/null ;;
    esac | sort -u
}

list_installed() {
    case "$DETECTED_PM" in
        pkg|nala|apt|dpkg) dpkg-query -W -f='${Package}\n' 2>/dev/null ;;
        dnf|yum)  rpm -qa --qf '%{NAME}\n' 2>/dev/null ;;
        pacman)   pacman -Qq 2>/dev/null ;;
        zypper)   rpm -qa --qf '%{NAME}\n' 2>/dev/null ;;
        apk)      apk list -I 2>/dev/null | cut -d' ' -f1 | sed 's/-[0-9].*//' ;;
    esac | sort -u
}

show_info() {
    local pkg="$1"
    echo -e "${BOLD}${CYAN}Package Information:${RESET}\n"
    case "$DETECTED_PM" in
        pkg)      pkg show "$pkg" 2>/dev/null ;;
        nala)     nala show "$pkg" 2>/dev/null ;;
        apt|dpkg) apt show "$pkg" 2>/dev/null ;;
        dnf)      dnf info "$pkg" 2>/dev/null ;;
        yum)      yum info "$pkg" 2>/dev/null ;;
        pacman)   pacman -Si "$pkg" 2>/dev/null || pacman -Qi "$pkg" 2>/dev/null ;;
        zypper)   zypper info "$pkg" 2>/dev/null ;;
        apk)      apk info -a "$pkg" 2>/dev/null ;;
    esac
}

show_help() {
    cat <<EOF
${BOLD}pget${RESET} v${VERSION} - Package Getter

${BOLD}Usage:${RESET}
  pget [options]
  pget -c [-s] -i <pkgs...>
  pget -c [-s] -r <pkgs...>

${BOLD}Options:${RESET}
  -c, --cli       CLI mode (direct execution)
  -s, --sudo      Run with sudo
  -i, --install   Install mode (default)
  -r, --remove    Remove mode
  -v, --version   Show version
  -h, --help      Show help

${BOLD}TUI Controls:${RESET}
  ↑/↓         Navigate
  Tab         Select multiple
  Enter       Confirm selection
  ?           Toggle preview
  Esc         Exit

${BOLD}Supported:${RESET} pkg, nala, apt, dpkg, dnf, yum, pacman, zypper, apk
EOF
    exit 0
}

parse_args() {
    local collecting=""
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -c|--cli)     CLI_MODE=true ;;
            -s|--sudo)    USE_SUDO=true ;;
            -i|--install) MODE="install"; collecting="pkg" ;;
            -r|--remove)  MODE="remove"; collecting="pkg" ;;
            -v|--version) echo "pget v${VERSION}"; exit 0 ;;
            -h|--help)    show_help ;;
            -*)           echo "${RED}Unknown: $1${RESET}" >&2; exit 1 ;;
            *)
                [[ "$1" =~ $PKG_REGEX ]] || { echo "${RED}Invalid package: $1${RESET}" >&2; exit 1; }
                [[ "$collecting" == "pkg" ]] && PACKAGES+=("$1")
                ;;
        esac
        shift
    done
}

run_cli() {
    if [[ ${#PACKAGES[@]} -eq 0 ]]; then
        echo "${YELLOW}No packages specified${RESET}"
        exit 1
    fi
    
    echo "${BOLD}${CYAN}pget${RESET} (${DETECTED_PM})$( [[ "$USE_SUDO" == true ]] && echo " ${CYAN}[sudo]${RESET}" )"
    echo
    
    if [[ "$MODE" == "install" ]]; then
        echo "${GREEN}Installing:${RESET} ${PACKAGES[*]}"
        run_pm install "${PACKAGES[@]}" && echo "${GREEN}✓ Done${RESET}" || echo "${RED}✗ Failed${RESET}"
    else
        echo "${RED}Removing:${RESET} ${PACKAGES[*]}"
        run_pm remove "${PACKAGES[@]}" && echo "${GREEN}✓ Done${RESET}" || echo "${RED}✗ Failed${RESET}"
    fi
}

run_tui_install() {
    tput civis 2>/dev/null || true
    
    local packages
    packages=$(list_available | fzf -m \
        --prompt="${BOLD}${GREEN}Install Package(s): ${RESET}" \
        --header="↑↓: Navigate | Tab: Select | Enter: Confirm | ?: Preview" \
        --preview="$0 --info {}" \
        --preview-window="top:40%" \
        --bind="?:toggle-preview" \
        --info=inline \
        --ansi 2>/dev/tty | tr "\n" " ")
    
    tput cnorm 2>/dev/null || true
    
    if [[ -z "$packages" ]]; then
        echo "${CYAN}No package selected${RESET}"
        return
    fi
    
    echo "Selected: $packages"
    echo
    
    while true; do
        local sudo_hint=""
        [[ "$USE_SUDO" == true ]] && sudo_hint=" ${CYAN}[sudo]${RESET}"
        read -n1 -rp "Install?${sudo_hint} [Y/n/s/q]: " choice
        echo
        
        case "$choice" in
            ""|y|Y)
                echo
                if run_pm install $packages; then
                    echo "${GREEN}✓ Installation complete${RESET}"
                else
                    echo "${RED}✗ Installation failed${RESET}"
                fi
                break
                ;;
            n|N) run_tui_install; break ;;
            s|S)
                USE_SUDO=$([[ "$USE_SUDO" == true ]] && echo false || echo true)
                echo "sudo: $USE_SUDO"
                ;;
            q|Q) echo "${CYAN}Exiting${RESET}"; break ;;
            *) echo "${RED}Y/n/s/q${RESET}" ;;
        esac
    done
}

run_tui_remove() {
    tput civis 2>/dev/null || true
    
    local packages
    packages=$(list_installed | fzf -m \
        --prompt="${BOLD}${RED}Remove Package(s): ${RESET}" \
        --header="↑↓: Navigate | Tab: Select | Enter: Confirm | ?: Preview" \
        --preview="$0 --info {}" \
        --preview-window="top:40%" \
        --bind="?:toggle-preview" \
        --info=inline \
        --ansi 2>/dev/tty | tr "\n" " ")
    
    tput cnorm 2>/dev/null || true
    
    if [[ -z "$packages" ]]; then
        echo "${CYAN}No package selected${RESET}"
        return
    fi
    
    echo "Selected: $packages"
    echo
    
    while true; do
        local sudo_hint=""
        [[ "$USE_SUDO" == true ]] && sudo_hint=" ${CYAN}[sudo]${RESET}"
        read -n1 -rp "Remove?${sudo_hint} [Y/n/s/q]: " choice
        echo
        
        case "$choice" in
            ""|y|Y)
                echo
                if run_pm remove $packages; then
                    echo "${GREEN}✓ Removal complete${RESET}"
                else
                    echo "${RED}✗ Removal failed${RESET}"
                fi
                break
                ;;
            n|N) run_tui_remove; break ;;
            s|S)
                USE_SUDO=$([[ "$USE_SUDO" == true ]] && echo false || echo true)
                echo "sudo: $USE_SUDO"
                ;;
            q|Q) echo "${CYAN}Exiting${RESET}"; break ;;
            *) echo "${RED}Y/n/s/q${RESET}" ;;
        esac
    done
}

run_tui() {
    echo "${BOLD}${CYAN}pget${RESET} (${DETECTED_PM})"
    echo
    
    while true; do
        local sudo_hint=""
        [[ "$USE_SUDO" == true ]] && sudo_hint=" ${CYAN}[sudo]${RESET}"
        read -n1 -rp "Mode${sudo_hint} [i]nstall/[r]emove/[s]udo/[q]uit: " mode_choice
        echo
        
        case "$mode_choice" in
            i|I) run_tui_install; break ;;
            r|R) run_tui_remove; break ;;
            s|S)
                USE_SUDO=$([[ "$USE_SUDO" == true ]] && echo false || echo true)
                echo "sudo: $USE_SUDO"
                ;;
            q|Q|"") echo "${CYAN}Exiting${RESET}"; break ;;
            *) echo "${RED}i/r/s/q${RESET}" ;;
        esac
    done
}

main() {
    [[ "${1:-}" == "--info" ]] && { detect_pm; show_info "$2"; exit 0; }
    parse_args "$@"
    detect_pm
    
    if [[ "$CLI_MODE" == true ]]; then
        run_cli
    else
        run_tui
    fi
}

main "$@"
